"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var e=t(require("chalk")),n=require("mocha"),r=t(require("axios")),i=require("date-fns");const s=function(){function t(){}return t.prototype.then=function(e,n){const r=new t,i=this.s;if(i){const t=1&i?e:n;if(t){try{o(r,1,t(this.v))}catch(t){o(r,2,t)}return r}return this}return this.o=function(t){try{const i=t.v;1&t.s?o(r,1,e?e(i):i):n?o(r,1,n(i)):o(r,2,i)}catch(t){o(r,2,t)}},r},t}();function o(t,e,n){if(!t.s){if(n instanceof s){if(!n.s)return void(n.o=o.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(o.bind(null,t,e),o.bind(null,t,2));t.s=e,t.v=n;const r=t.o;r&&r(t)}}function a(t){return t instanceof s&&1&t.s}var u;"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator"))),function(t){t[t.Passed=1]="Passed",t[t.Blocked=2]="Blocked",t[t.Untested=3]="Untested",t[t.Retest=4]="Retest",t[t.Failed=5]="Failed"}(u||(u={}));var c=function(t,e,n){this.id=t,this.name=e,this.description=n,this.caseIds=[],this.runId=null},d=function(){function t(t){this.options=t,this.suites=[],this.testResults=[],this.axiosInstance=r.create({baseURL:"https://"+t.domain+"/index.php?/api/v2",headers:{"Content-Type":"application/json"},auth:{username:t.username,password:t.password}}),this.projectId=t.projectId,this.planId=t.planId,this.today=i.format((new Date).getTime(),"yyyy/MM/dd")}var n,d=t.prototype;return d.addFailedTest=function(t,e){var n=this.findRunIdForCase(t);n&&this.testResults.push({case_id:t,status_id:u.Failed,run_id:n,comment:e.err.message})},d.addPassedTest=function(t,e){var n=this.findRunIdForCase(t);n&&this.testResults.push({case_id:t,status_id:u.Passed,run_id:n,comment:"Execution time: "+e.duration+"ms"})},d.constructSuites=function(){try{var n=this,r=function(e,r){try{var i=Promise.resolve(n.axiosInstance.get("/get_suites/"+n.projectId)).then((function(e){var r=e.data.filter((function(t){return!t.name.includes("Master")})).sort((function(t,e){return t.name>e.name?1:t.name<e.name?-1:0})),i=Array.isArray(r),s=0;for(r=i?r:r[Symbol.iterator]();;){var o;if(i){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}n.suites.push(new c(o.id,o.name,o.description))}return Promise.resolve(n.axiosInstance.get("/get_plan/"+n.planId)).then((function(e){function r(){var t=function(){if(r){if(i>=e.length)return"break";o=e[i++]}else{if((i=e.next()).done)return"break";o=i.value}var t=o;n.suites.forEach((function(e){e.id===t.suite_id&&(e.runId=t.id)}))},e=s,r=Array.isArray(e),i=0;for(e=r?e:e[Symbol.iterator]();;){var o;if("break"===t())break}return Promise.resolve(n.getCases()).then((function(){}))}var i=e.data,s=[],o=function(){if(!i.entries||!i.entries.length)return Promise.resolve(n.createRuns()).then((function(t){s=t}));s=t.flat(i.entries.map((function(t){return t.runs})))}();return o&&o.then?o.then(r):r()}))}))}catch(t){return r(t)}return i&&i.then?i.then(void 0,r):i}(0,(function(t){console.log(e.redBright.underline.bold("Internal error",t))}));return Promise.resolve(r&&r.then?r.then((function(){})):void 0)}catch(t){return Promise.reject(t)}},d.publish=function(){try{var t=this,n=t.constructTestResult(),r=Object.entries(n).map((function(e){return t.axiosInstance.post("/add_results_for_cases/"+e[0],{results:e[1]})}));return Promise.resolve(Promise.all(r)).then((function(){console.log("\n",e.magenta.underline.bold("(TestRail Reporter)")),console.log("\n"," - Results are published to "+e.magenta("https://"+t.options.domain+"/index.php?/runs/plan/"+t.planId),"\n")}))}catch(t){return Promise.reject(t)}},d.constructTestResult=function(){return this.testResults.reduce((function(t,e){var n=e.run_id,r=function(t,e){if(null==t)return{};var n,r,i={},s=Object.keys(t);for(r=0;r<s.length;r++)e.indexOf(n=s[r])>=0||(i[n]=t[n]);return i}(e,["run_id"]);return t[n]=t[n]?[].concat(t[n],[r]):[r],t}),{})},d.findRunIdForCase=function(t){var e=this.suites.find((function(e){return e.caseIds.includes(t)}));return e?e.runId:0},d.createRuns=function(){try{var t=this,e=[],n=0,r=function(t,e,n){for(var r;;){var i=t();if(a(i)&&(i=i.v),!i)return u;if(i.then){r=0;break}var u=n();if(u&&u.then){if(!a(u)){r=1;break}u=u.s}if(e){var c=e();if(c&&c.then&&!a(c)){r=2;break}}}var d=new s,l=o.bind(null,d,2);return(0===r?i.then(h):1===r?u.then(f):c.then(p)).then(void 0,l),d;function f(r){u=r;do{if(e&&(c=e())&&c.then&&!a(c))return void c.then(p).then(void 0,l);if(!(i=t())||a(i)&&!i.v)return void o(d,1,u);if(i.then)return void i.then(h).then(void 0,l);a(u=n())&&(u=u.v)}while(!u||!u.then);u.then(f).then(void 0,l)}function h(t){t?(u=n())&&u.then?u.then(f).then(void 0,l):f(u):o(d,1,u)}function p(){(i=t())?i.then?i.then(h).then(void 0,l):h(i):o(d,1,u)}}((function(){return n<t.suites.length}),(function(){return n++}),(function(){var r=t.suites[n];return Promise.resolve(t.axiosInstance.post("/add_plan_entry/"+t.planId,{suite_id:r.id,name:r.name,description:r.description+" "+t.today}).then((function(t){return t.data.runs[0]}))).then((function(t){e.push(t)}))}));return Promise.resolve(r&&r.then?r.then((function(){return e})):e)}catch(t){return Promise.reject(t)}},d.getCases=function(){try{var e=this,n=e.suites.map((function(t){return e.axiosInstance.get("/get_cases/"+e.projectId+"&suite_id="+t.id)}));return Promise.resolve(Promise.all(n)).then((function(n){var r=function(){if(s){if(o>=i.length)return"break";a=i[o++]}else{if((o=i.next()).done)return"break";a=o.value}var t=a;e.suites.forEach((function(e){e.id===t.suite_id&&e.caseIds.push(t.id)}))},i=t.flat(n.map((function(t){return t.data}))),s=Array.isArray(i),o=0;for(i=s?i:i[Symbol.iterator]();;){var a;if("break"===r())break}}))}catch(t){return Promise.reject(t)}},t.flat=function(t){return t.reduce((function(t,e){return t.concat(e)}),[])},(n=[{key:"results",get:function(){return this.testResults}}])&&function(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}(t.prototype,n),t}(),l=function(t){for(var e,n=/\bT?C(\d+)\b/g,r=null;null!==(e=n.exec(t));)r=parseInt(e[1]);return r};module.exports=function(t){var n,r;function i(n,r){var s;(s=t.call(this,n,r)||this).handleTest=function(t){return function(e){var n=l(e.title);n&&("fail"===t?s.testRail.addFailedTest(n,e):s.testRail.addPassedTest(n,e))}},s.handleEnd=function(){if(!s.testRail.results.length)return console.log("\n",e.magenta.underline.bold("(TestRail Reporter)")),void console.warn("\n","No testcases were matched. Ensure that your tests are declared correctly and matches Cxxx","\n");s.testRail.publish().catch(console.error)};var o=r.reporterOptions;return i.validate(o),s.testRail=new d(o),s.report(),s}return r=t,(n=i).prototype=Object.create(r.prototype),n.prototype.constructor=n,n.__proto__=r,i.prototype.report=function(){this.runner.once("start",this.testRail.constructSuites.bind(this.testRail)),this.runner.on("fail",this.handleTest("fail")),this.runner.on("pass",this.handleTest("pass")),this.runner.on("end",this.handleEnd)},i.validate=function(t){if(null==t)throw new Error("No reporterOptions");for(var e in t)if(!t[e])throw new Error("Missing "+e+" value. Update repoterOptions")},i}(n.reporters.Base);
//# sourceMappingURL=cypress-testrail-reporter.cjs.production.min.js.map
