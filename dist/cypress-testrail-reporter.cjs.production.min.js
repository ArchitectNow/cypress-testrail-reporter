"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t,n=e(require("chalk")),r=require("mocha"),s=e(require("axios")),i=require("date-fns");"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator"))),function(e){e[e.Passed=1]="Passed",e[e.Blocked=2]="Blocked",e[e.Untested=3]="Untested",e[e.Retest=4]="Retest",e[e.Failed=5]="Failed"}(t||(t={}));var a=function(e,t,n){this.id=e,this.name=t,this.description=n,this.caseIds=[],this.runId=null},o=function(){function e(e){this.options=e,this.suites=[],this.testResults=[],this.axiosInstance=s.create({baseURL:"https://"+e.domain+"/index.php?/api/v2",headers:{"Content-Type":"application/json"},auth:{username:e.username,password:e.password}}),this.projectId=e.projectId,this.planId=e.planId,this.today=i.format((new Date).getTime(),"yyyy/MM/dd")}var r,o=e.prototype;return o.addFailedTest=function(e,n){var r=this.findRunIdForCase(e);r&&this.testResults.push({case_id:e,status_id:t.Failed,run_id:r,comment:n.err.message})},o.addPassedTest=function(e,n){var r=this.findRunIdForCase(e);r&&this.testResults.push({case_id:e,status_id:t.Passed,run_id:r,comment:"Execution time: "+n.duration+"ms"})},o.constructSuites=function(){try{var t=this,r=function(n,r){try{var s=Promise.resolve(t.axiosInstance.get("/get_suites/"+t.projectId)).then((function(n){var r=n.data,s=Array.isArray(r),i=0;for(r=s?r:r[Symbol.iterator]();;){var o;if(s){if(i>=r.length)break;o=r[i++]}else{if((i=r.next()).done)break;o=i.value}t.suites.push(new a(o.id,o.name,o.description))}return Promise.resolve(t.axiosInstance.get("/get_plan/"+t.planId)).then((function(n){function r(){var e=function(){if(r){if(i>=n.length)return"break";a=n[i++]}else{if((i=n.next()).done)return"break";a=i.value}var e=a;t.suites.forEach((function(t){t.id===e.suite_id&&(t.runId=e.id)}))},n=s,r=Array.isArray(n),i=0;for(n=r?n:n[Symbol.iterator]();;){var a;if("break"===e())break}return Promise.resolve(t.getCases()).then((function(){}))}var s,i=n.data,a=function(){if(!i.entries||!i.entries.length)return Promise.resolve(t.createRuns()).then((function(t){s=e.flat(t.map((function(e){return e.data.entries})))}));s=i.entries}();return a&&a.then?a.then(r):r()}))}))}catch(e){return r(e)}return s&&s.then?s.then(void 0,r):s}(0,(function(e){console.log(n.redBright.underline.bold("Internal error",e))}));return Promise.resolve(r&&r.then?r.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},o.publish=function(){var e=this,t=this.constructTestResult(),r=Object.entries(t).map((function(t){return e.axiosInstance.post("/add_results_for_cases/"+t[0],{results:t[1]})}));Promise.all(r).then((function(){console.log("\n",n.magenta.underline.bold("(TestRail Reporter)")),console.log("\n"," - Results are published to "+n.magenta("https://"+e.options.domain+"/index.php?/runs/plan/"+e.planId),"\n")}))},o.constructTestResult=function(){return this.testResults.reduce((function(e,t){var n=t.run_id,r=function(e,t){if(null==e)return{};var n,r,s={},i=Object.keys(e);for(r=0;r<i.length;r++)t.indexOf(n=i[r])>=0||(s[n]=e[n]);return s}(t,["run_id"]);return e[n]=e[n]?[].concat(e[n],[r]):[r],e}),{})},o.findRunIdForCase=function(e){var t=this.suites.find((function(t){return t.caseIds.includes(e)}));return t?t.runId:0},o.createRuns=function(){try{var e=this,t=e.suites.map((function(t){return e.axiosInstance.post("/add_plan_entry/"+e.planId,{suite_id:t.id,name:t.name,description:t.description+" "+e.today})}));return Promise.all(t)}catch(e){return Promise.reject(e)}},o.getCases=function(){try{var t=this,n=t.suites.map((function(e){return t.axiosInstance.get("/get_cases/"+t.projectId+"&suite_id="+e.id)}));return Promise.resolve(Promise.all(n)).then((function(n){var r=function(){if(i){if(a>=s.length)return"break";o=s[a++]}else{if((a=s.next()).done)return"break";o=a.value}var e=o;t.suites.forEach((function(t){t.id===e.suite_id&&t.caseIds.push(e.id)}))},s=e.flat(n.map((function(e){return e.data}))),i=Array.isArray(s),a=0;for(s=i?s:s[Symbol.iterator]();;){var o;if("break"===r())break}}))}catch(e){return Promise.reject(e)}},e.flat=function(e){return e.reduce((function(e,t){return e.concat(t)}),[])},(r=[{key:"results",get:function(){return this.testResults}}])&&function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(e.prototype,r),e}(),u=function(e){for(var t,n=/\bT?C(\d+)\b/g,r=null;null!==(t=n.exec(e));)r=parseInt(t[1]);return r};module.exports=function(e){var t,r;function s(t,r){var i;(i=e.call(this,t,r)||this).handleTest=function(e){return function(t){var n=u(t.title);n&&("fail"===e?i.testRail.addFailedTest(n,t):i.testRail.addPassedTest(n,t))}},i.handleEnd=function(){if(!i.testRail.results.length)return console.log("\n",n.magenta.underline.bold("(TestRail Reporter)")),void console.warn("\n","No testcases were matched. Ensure that your tests are declared correctly and matches Cxxx","\n");i.testRail.publish()};var a=r.reporterOptions;return s.validate(a),i.testRail=new o(a),i.report(),i}return r=e,(t=s).prototype=Object.create(r.prototype),t.prototype.constructor=t,t.__proto__=r,s.prototype.report=function(){this.runner.once("start",this.testRail.constructSuites.bind(this.testRail)),this.runner.on("fail",this.handleTest("fail")),this.runner.on("pass",this.handleTest("pass")),this.runner.on("end",this.handleEnd)},s.validate=function(e){if(null==e)throw new Error("No reporterOptions");for(var t in e)if(!e[t])throw new Error("Missing "+t+" value. Update repoterOptions")},s}(r.reporters.Base);
//# sourceMappingURL=cypress-testrail-reporter.cjs.production.min.js.map
