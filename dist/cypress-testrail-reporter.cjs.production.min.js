"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t,r=e(require("chalk")),n=require("mocha"),s=e(require("axios")),i=require("date-fns");"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator"))),function(e){e[e.Passed=1]="Passed",e[e.Blocked=2]="Blocked",e[e.Untested=3]="Untested",e[e.Retest=4]="Retest",e[e.Failed=5]="Failed"}(t||(t={}));var o=function(e,t,r){this.id=e,this.name=t,this.description=r,this.caseIds=[],this.runId=null},a=function(){function e(e){this.suites=[],this.testResults=[],this.axiosInstance=s.create({baseURL:"https://"+e.domain+"/index.php?/api/v2",headers:{"Content-Type":"application/json"},auth:{username:e.username,password:e.password}}),this.projectId=e.projectId,this.planId=e.planId,this.today=i.format((new Date).getTime(),"yyyy/MM/dd")}var n,a=e.prototype;return a.addFailedTest=function(e,r){var n=this.findRunIdForCase(e);n&&this.testResults.push({case_id:e,status_id:t.Failed,run_id:n,comment:r.err.message})},a.addPassedTest=function(e,r){var n=this.findRunIdForCase(e);n&&this.testResults.push({case_id:e,status_id:t.Passed,run_id:n,comment:"Execution time: "+r.duration+"ms"})},a.constructSuites=function(){try{var t=this,n=function(r,n){try{var s=Promise.resolve(t.axiosInstance.get("/get_suites/"+t.projectId)).then((function(r){var n=r.data,s=Array.isArray(n),i=0;for(n=s?n:n[Symbol.iterator]();;){var a;if(s){if(i>=n.length)break;a=n[i++]}else{if((i=n.next()).done)break;a=i.value}t.suites.push(new o(a.id,a.name,a.description))}return Promise.resolve(t.axiosInstance.get("/get_plan/"+t.planId)).then((function(r){function n(){var e=function(){if(n){if(i>=r.length)return"break";o=r[i++]}else{if((i=r.next()).done)return"break";o=i.value}var e=o;t.suites.forEach((function(t){t.id===e.suite_id&&(t.runId=e.runs[0].id)}))},r=s,n=Array.isArray(r),i=0;for(r=n?r:r[Symbol.iterator]();;){var o;if("break"===e())break}return Promise.resolve(t.getCases()).then((function(){}))}var s,i=r.data,o=function(){if(!i.entries||!i.entries.length)return Promise.resolve(t.createRuns()).then((function(t){s=e.flat(t.map((function(e){return e.data.entries})))}));s=i.entries}();return o&&o.then?o.then(n):n()}))}))}catch(e){return n(e)}return s&&s.then?s.then(void 0,n):s}(0,(function(e){console.log(r.redBright.underline.bold("Internal error",e))}));return Promise.resolve(n&&n.then?n.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},a.publish=function(){var e=this,t=this.constructTestResult(),r=Object.entries(t).map((function(t){return e.axiosInstance.post("/add_results_for_cases/"+t[0],{results:t[1]})}));return Promise.all(r)},a.constructTestResult=function(){return this.testResults.reduce((function(e,t){var r=t.run_id,n=function(e,t){if(null==e)return{};var r,n,s={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(s[r]=e[r]);return s}(t,["run_id"]);return e[r]=e[r]?[].concat(e[r],[n]):[n],e}),{})},a.findRunIdForCase=function(e){var t=this.suites.find((function(t){return t.caseIds.includes(e)}));return t?t.runId:0},a.createRuns=function(){try{var e=this,t=e.suites.map((function(t){return e.axiosInstance.post("/add_plan_entry/"+e.planId,{suite_id:t.id,name:t.name,description:t.description+" "+e.today})}));return Promise.all(t)}catch(e){return Promise.reject(e)}},a.getCases=function(){try{var t=this,r=t.suites.map((function(e){return t.axiosInstance.get("/get_cases/"+t.projectId+"&suite_id="+e.id)}));return Promise.resolve(Promise.all(r)).then((function(r){var n=function(){if(i){if(o>=s.length)return"break";a=s[o++]}else{if((o=s.next()).done)return"break";a=o.value}var e=a;t.suites.forEach((function(t){t.id===e.suite_id&&t.caseIds.push(e.id)}))},s=e.flat(r.map((function(e){return e.data}))),i=Array.isArray(s),o=0;for(s=i?s:s[Symbol.iterator]();;){var a;if("break"===n())break}}))}catch(e){return Promise.reject(e)}},e.flat=function(e){return e.reduce((function(e,t){return e.concat(t)}),[])},(n=[{key:"results",get:function(){return this.testResults}}])&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(e.prototype,n),e}(),u=function(e){for(var t,r=/\bT?C(\d+)\b/g,n=null;null!==(t=r.exec(e));)n=parseInt(t[1]);return n};module.exports=function(e){var t,n;function s(t,n){var i;return(i=e.call(this,t,n)||this).handleTest=function(e){return function(t){var r=u(t.title);r&&("fail"===e?i.testRail.addFailedTest(r,t):i.testRail.addPassedTest(r,t))}},i.handleEnd=function(){if(!i.testRail.results.length)return console.log("\n",r.magenta.underline.bold("(TestRail Reporter)")),void console.warn("\n","No testcases were matched. Ensure that your tests are declared correctly and matches Cxxx","\n");i.testRail.publish().then((function(){console.log("\n",r.magenta.underline.bold("(TestRail Reporter)")),console.log("\n"," - Results are published to "+r.magenta("https://"+i.reporterOptions.domain+"/index.php?/runs/plan/"+i.reporterOptions.planId),"\n")})).catch(console.error)},i.reporterOptions=n.reporterOptions,s.validate(i.reporterOptions),i.testRail=new a(i.reporterOptions),i.report(),i}return n=e,(t=s).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n,s.prototype.report=function(){this.runner.once("start",this.testRail.constructSuites.bind(this.testRail)),this.runner.on("fail",this.handleTest("fail")),this.runner.on("pass",this.handleTest("pass")),this.runner.on("end",this.handleEnd)},s.validate=function(e){if(null==e)throw new Error("No reporterOptions");for(var t in e)if(!e[t])throw new Error("Missing "+t+" value. Update repoterOptions")},s}(n.reporters.Base);
//# sourceMappingURL=cypress-testrail-reporter.cjs.production.min.js.map
