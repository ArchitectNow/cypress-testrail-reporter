"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t,n=e(require("chalk")),r=require("mocha"),s=e(require("axios")),i=require("date-fns");"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator"))),function(e){e[e.Passed=1]="Passed",e[e.Blocked=2]="Blocked",e[e.Untested=3]="Untested",e[e.Retest=4]="Retest",e[e.Failed=5]="Failed"}(t||(t={}));var a=function(e,t,n){this.id=e,this.name=t,this.description=n,this.caseIds=[],this.runId=null},o=function(){function e(e){this.options=e,this.suites=[],this.testResults=[],this.axiosInstance=s.create({baseURL:"https://"+e.domain+"/index.php?/api/v2",headers:{"Content-Type":"application/json"},auth:{username:e.username,password:e.password}}),this.projectId=e.projectId,this.planId=e.planId,this.today=i.format((new Date).getTime(),"yyyy/MM/dd")}var r,o=e.prototype;return o.addFailedTest=function(e,n){var r=this.findRunIdForCase(e);r&&this.testResults.push({case_id:e,status_id:t.Failed,run_id:r,comment:n.err.message})},o.addPassedTest=function(e,n){var r=this.findRunIdForCase(e);r&&this.testResults.push({case_id:e,status_id:t.Passed,run_id:r,comment:"Execution time: "+n.duration+"ms"})},o.constructSuites=function(){try{var e=this,t=function(t,n){try{var r=Promise.resolve(e.axiosInstance.get("/get_suites/"+e.projectId)).then((function(t){var n=t.data,r=Array.isArray(n),s=0;for(n=r?n:n[Symbol.iterator]();;){var i;if(r){if(s>=n.length)break;i=n[s++]}else{if((s=n.next()).done)break;i=s.value}e.suites.push(new a(i.id,i.name,i.description))}return Promise.resolve(e.axiosInstance.get("/get_plan/"+e.planId)).then((function(t){function n(){var t=function(){if(s){if(i>=n.length)return"break";a=n[i++]}else{if((i=n.next()).done)return"break";a=i.value}var t=a;e.suites.forEach((function(e){e.id===t.suite_id&&(e.runId=t.id)}))},n=r,s=Array.isArray(n),i=0;for(n=s?n:n[Symbol.iterator]();;){var a;if("break"===t())break}return Promise.resolve(e.getCases()).then((function(){}))}var r,s=t.data,i=function(){if(!s.entries||!s.entries.length)return Promise.resolve(e.createRuns()).then((function(e){r=e.map((function(e){return e.data.entries})).flat()}));r=s.entries}();return i&&i.then?i.then(n):n()}))}))}catch(e){return n(e)}return r&&r.then?r.then(void 0,n):r}(0,(function(e){console.log(n.redBright.underline.bold("Internal error",e))}));return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},o.publish=function(){var e=this,t=this.constructTestResult(),r=Object.entries(t).map((function(t){return e.axiosInstance.post("/add_results_for_cases/"+t[0],{results:t[1]})}));Promise.all(r).then((function(){console.log("\n",n.magenta.underline.bold("(TestRail Reporter)")),console.log("\n"," - Results are published to "+n.magenta("https://"+e.options.domain+"/index.php?/runs/plan/"+e.planId),"\n")}))},o.constructTestResult=function(){return this.testResults.reduce((function(e,t){var n=t.run_id,r=function(e,t){if(null==e)return{};var n,r,s={},i=Object.keys(e);for(r=0;r<i.length;r++)t.indexOf(n=i[r])>=0||(s[n]=e[n]);return s}(t,["run_id"]);return e[n]=e[n]?[].concat(e[n],[r]):[r],e}),{})},o.findRunIdForCase=function(e){var t=this.suites.find((function(t){return t.caseIds.includes(e)}));return t?t.runId:0},o.createRuns=function(){try{var e=this,t=e.suites.map((function(t){return e.axiosInstance.post("/add_plan_entry/"+e.planId,{suite_id:t.id,name:t.name,description:t.description+" "+e.today})}));return Promise.all(t)}catch(e){return Promise.reject(e)}},o.getCases=function(){try{var e=this,t=e.suites.map((function(t){return e.axiosInstance.get("/get_cases/"+e.projectId+"&suite_id="+t.id)}));return Promise.resolve(Promise.all(t)).then((function(t){var n=function(){if(s){if(i>=r.length)return"break";a=r[i++]}else{if((i=r.next()).done)return"break";a=i.value}var t=a;e.suites.forEach((function(e){e.id===t.suite_id&&e.caseIds.push(t.id)}))},r=t.map((function(e){return e.data})).flat(),s=Array.isArray(r),i=0;for(r=s?r:r[Symbol.iterator]();;){var a;if("break"===n())break}}))}catch(e){return Promise.reject(e)}},(r=[{key:"results",get:function(){return this.testResults}}])&&function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(e.prototype,r),e}(),u=function(e){for(var t,n=/\bT?C(\d+)\b/g,r=null;null!==(t=n.exec(e));)r=parseInt(t[1]);return r};module.exports=function(e){var t,r;function s(t,r){var i;(i=e.call(this,t,r)||this).handleTest=function(e){return function(t){var n=u(t.title);n&&("fail"===e?i.testRail.addFailedTest(n,t):i.testRail.addPassedTest(n,t))}},i.handleEnd=function(){if(i.runner.off("fail",i.handleTest("fail")),i.runner.off("pass",i.handleTest("pass")),!i.testRail.results.length)return console.log("\n",n.magenta.underline.bold("(TestRail Reporter)")),void console.warn("\n","No testcases were matched. Ensure that your tests are declared correctly and matches Cxxx","\n");i.testRail.publish(),i.runner.off("end",i.handleEnd)};var a=r.reporterOptions;return s.validate(a),i.testRail=new o(a),i.report(),i}return r=e,(t=s).prototype=Object.create(r.prototype),t.prototype.constructor=t,t.__proto__=r,s.prototype.report=function(){this.runner.once("start",this.testRail.constructSuites.bind(this.testRail)),this.runner.on("fail",this.handleTest("fail")),this.runner.on("pass",this.handleTest("pass")),this.runner.on("end",this.handleEnd)},s.validate=function(e){if(null==e)throw new Error("No reporterOptions");for(var t in e)if(!e[t])throw new Error("Missing "+t+" value. Update repoterOptions")},s}(r.reporters.Base);
//# sourceMappingURL=cypress-testrail-reporter.cjs.production.min.js.map
